<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>htmllint Source: linter.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.cerulean.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">htmllint</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="htmllint.html">htmllint</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="Linter.html">Linter</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: linter.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">var bulk = require('bulk-require'),
    lodash = require('lodash'),
    Parser = require('./parser'),
    path = require('path');
var envs = bulk(path.join(__dirname, '/envs'), '*.js');

/**
 * A linter is configured with a set of rules that are fed the raw
 * html and ast nodes.
 * @constructor
 */
var Linter = function (rules) {
    this.rules = rules || {};
    this.parser = new Parser();
};
module.exports = Linter;

/**
 * @function
 * @name addRule
 * @param {rule} rule - your custom rule to add.
 * Assigns a rule to the Linter's rule object.
 */
Linter.prototype.addRule = function (rule) {
    this.rules[rule.name] = rule;
};

/**
 * @function
 * @name lint
 * @param {string} html - the html as a string to lint.
 * Lints the HTML with the options supplied in the environments setup.
 */
Linter.prototype.lint = function (html) {
    var params = lodash.flatten(arguments),
        opts = lodash.cloneDeep(envs.none);

    for (var i = 1; i &lt; params.length; i++) {
        if ( typeof params[i] === 'string') {
            params[i] = envs[params[i]] || {};
        }
    }

    //we can do this because the first param is our html string
    params[0] = opts;
    opts = lodash.merge.apply(lodash, params);

    //stuff
    var dom = null,
        scanIssues = [],
        domIssues = [],
        maxerr = (opts ? opts.maxerr : null) || 30,
        lines = null;

    // break up the html into array of objects of lines
    lines = this.shred(html);

    // process dom
    dom = this.parser.parse(html);

    // Get our lines linted
    scanIssues = this.execLines(lines, opts);
    //scanIssues = this.execRule(lines, 'scan', null, opts);

    // Get our DOM linted
    domIssues = this.execDom(dom, opts);

    // call the end handler on rules
    // TODO: create a handler subset?
    lodash.forOwn(this.rules, function callRuleEnd(rule) {
        if (rule.end) {
            rule.end(opts);
        }
    });

    // Return to sender
    return lodash.first(scanIssues.concat(domIssues), maxerr);
};

Linter.prototype.execLines = function (lines, opts) {
    var linter = this,
        ruleNames = Object.keys(this.rules).filter(function (ruleName) {
            //console.log('process');
            return this.rules[ruleName].scan;
        }.bind(this));

    return lodash(lines).map(function (line, index) {
        if (index === 0) {return false;}

        // inline goes here

        return lodash(ruleNames).map(function (ruleName) {
            var rule = linter.rules[ruleName];
            return rule.scan.apply(rule, [line, opts]);
        }).flatten().compact().value();
    }).flatten().compact().value();
};

Linter.prototype.execDom = function (dom, opts) {
    var linter = this,
        ruleNames = Object.keys(this.rules).filter(function (ruleName) {
            return this.rules[ruleName].process;
        }.bind(this));

    var getIssues = function (element) {
        var ret = lodash(ruleNames).map(function (ruleName) {
            var rule = linter.rules[ruleName];
            if (!rule.trigger || rule.trigger.indexOf(element.name) > -1) {
                return rule.process.apply(rule, [element, opts]);
            } else {
                return [];
            }
        }).flatten().compact().value();

        if (element.children &amp;&amp; element.children.length > 0) {
            element.children.forEach(function (child) {
                ret = ret.concat(getIssues(child));
            });
        }
        return ret;
    };

    var issues = dom.length ? dom.map(getIssues) : [];
    return lodash.flatten(issues);
};

/**
 * @function
 * @name shred
 * @param {html} html - your html.
 * @returns {string} the array of line objects.
 * 'Shreds' the html by line for linting by line.
 */
Linter.prototype.shred = function (html) {
    // Take the HTML string
    // Return an array of {line, line number, index}
    var shredder = /(.*)\n/g,
        row = 1,
        line = shredder.exec(html),
        shredded = [];

    while (line) {
        shredded[row] = {
            'line': line[0],
            'index': line.index,
            'row': row
        };
        row++;
        line = shredder.exec(html);
    }

    return shredded;
};
</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a>
		on Mon Sep 29 2014 14:02:08 GMT-0400 (EDT) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:true,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
